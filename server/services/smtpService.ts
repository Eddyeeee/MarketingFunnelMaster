import nodemailer from 'nodemailer';
import { storage } from '../storage';

export interface EmailConfig {
  provider: 'gmail' | 'sendgrid' | 'mailgun' | 'custom';
  host?: string;
  port?: number;
  secure?: boolean;
  auth: {
    user: string;
    pass: string;
  };
  from: string;
  fromName: string;
}

export interface EmailTemplate {
  subject: string;
  html: string;
  text: string;
  variables: string[];
}

export interface EmailData {
  to: string;
  subject: string;
  html: string;
  text: string;
  personaType: string;
  leadId?: number;
  templateId?: string;
}

export class SMTPService {
  private transporter: nodemailer.Transporter | null = null;
  private config: EmailConfig | null = null;

  async initialize(config: EmailConfig): Promise<boolean> {
    try {
      this.config = config;
      
      // Konfiguriere Transporter basierend auf Provider
      switch (config.provider) {
        case 'gmail':
          this.transporter = nodemailer.createTransporter({
            service: 'gmail',
            auth: config.auth
          });
          break;
          
        case 'sendgrid':
          this.transporter = nodemailer.createTransporter({
            host: 'smtp.sendgrid.net',
            port: 587,
            secure: false,
            auth: config.auth
          });
          break;
          
        case 'mailgun':
          this.transporter = nodemailer.createTransporter({
            host: 'smtp.mailgun.org',
            port: 587,
            secure: false,
            auth: config.auth
          });
          break;
          
        case 'custom':
          this.transporter = nodemailer.createTransporter({
            host: config.host,
            port: config.port,
            secure: config.secure,
            auth: config.auth
          });
          break;
      }

      // Teste Verbindung
      await this.transporter.verify();
      console.log('SMTP-Verbindung erfolgreich hergestellt');
      return true;
    } catch (error) {
      console.error('SMTP-Verbindung fehlgeschlagen:', error);
      return false;
    }
  }

  async sendEmail(emailData: EmailData): Promise<boolean> {
    if (!this.transporter || !this.config) {
      console.error('SMTP nicht initialisiert');
      return false;
    }

    try {
      const mailOptions = {
        from: `"${this.config.fromName}" <${this.config.from}>`,
        to: emailData.to,
        subject: emailData.subject,
        html: emailData.html,
        text: emailData.text,
        headers: {
          'X-Persona-Type': emailData.personaType,
          'X-Lead-ID': emailData.leadId?.toString() || '',
          'X-Template-ID': emailData.templateId || ''
        }
      };

      const result = await this.transporter.sendMail(mailOptions);
      
      // Track E-Mail-Versendung
      await this.trackEmailSent(emailData, result.messageId);
      
      console.log(`E-Mail erfolgreich gesendet: ${result.messageId}`);
      return true;
    } catch (error) {
      console.error('E-Mail-Versendung fehlgeschlagen:', error);
      await this.trackEmailError(emailData, error);
      return false;
    }
  }

  async sendBulkEmails(emails: EmailData[]): Promise<{ success: number; failed: number }> {
    let success = 0;
    let failed = 0;

    for (const email of emails) {
      const result = await this.sendEmail(email);
      if (result) {
        success++;
      } else {
        failed++;
      }
      
      // Rate Limiting f√ºr Bulk-Versendung
      await new Promise(resolve => setTimeout(resolve, 100));
    }

    return { success, failed };
  }

  async sendPersonaEmail(personaType: string, leadData: any, templateId: string): Promise<boolean> {
    const template = await this.getPersonaTemplate(personaType, templateId);
    if (!template) {
      console.error(`Template nicht gefunden: ${templateId}`);
      return false;
    }

    const personalizedHtml = this.personalizeTemplate(template.html, leadData, personaType);
    const personalizedText = this.personalizeTemplate(template.text, leadData, personaType);
    const personalizedSubject = this.personalizeTemplate(template.subject, leadData, personaType);

    const emailData: EmailData = {
      to: leadData.email,
      subject: personalizedSubject,
      html: personalizedHtml,
      text: personalizedText,
      personaType,
      leadId: leadData.id,
      templateId
    };

    return await this.sendEmail(emailData);
  }

  private async getPersonaTemplate(personaType: string, templateId: string): Promise<EmailTemplate | null> {
    // Hier w√ºrden normalerweise Templates aus der Datenbank geladen
    const templates = {
      // STUDENT TEMPLATES
      'student_welcome': {
        subject: 'üéì Willkommen im Studenten-Programm, {firstName}!',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #3b82f6;">üéì Willkommen im Studenten-Programm!</h1>
            <p>Hallo {firstName},</p>
            <p>herzlich willkommen im Magic Tool System f√ºr Studenten!</p>
            <p>Du hast den ersten Schritt gemacht und bist jetzt Teil einer exklusiven Community von Studenten, die bereits 500‚Ç¨+ monatlich verdienen.</p>
            
            <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h3 style="color: #1e40af;">Dein n√§chster Schritt:</h3>
              <ol>
                <li>Schau dir die VSL an: <a href="{vslUrl}">Hier klicken</a></li>
                <li>Lade deine Bonus-Materialien herunter</li>
                <li>Trete der Studenten-Community bei</li>
              </ol>
            </div>
            
            <p>Viel Erfolg auf deinem Weg zu 500‚Ç¨+ monatlich!</p>
            <p>Dein Magic Tool Team</p>
          </div>
        `,
        text: `
          Willkommen im Studenten-Programm!
          
          Hallo {firstName},
          
          herzlich willkommen im Magic Tool System f√ºr Studenten!
          
          Dein n√§chster Schritt:
          1. Schau dir die VSL an: {vslUrl}
          2. Lade deine Bonus-Materialien herunter
          3. Trete der Studenten-Community bei
          
          Viel Erfolg!
          Dein Magic Tool Team
        `,
        variables: ['firstName', 'vslUrl']
      },
      'student_followup_1': {
        subject: 'üìö Dein Studenten-Erfolgsplan wartet auf dich!',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #3b82f6;">üìö Dein Studenten-Erfolgsplan</h1>
            <p>Hallo {firstName},</p>
            <p>ich hoffe, du hast die VSL bereits angeschaut! Falls nicht, hier ist dein direkter Link:</p>
            <p><a href="{vslUrl}" style="background: #3b82f6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">üéØ VSL jetzt ansehen</a></p>
            
            <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h3 style="color: #92400e;">üî• Exklusives Studenten-Angebot:</h3>
              <p><strong>Nur noch 24 Stunden: 50% Rabatt auf das Premium-Paket!</strong></p>
              <p>Statt 197‚Ç¨ nur 97‚Ç¨ - inklusive 1:1 Coaching Session!</p>
            </div>
            
            <p>Viele Studenten haben bereits mit dem Magic Tool System begonnen. Wirst du der n√§chste Erfolgsfall?</p>
            <p>Dein Magic Tool Team</p>
          </div>
        `,
        text: `
          Dein Studenten-Erfolgsplan
          
          Hallo {firstName},
          
          ich hoffe, du hast die VSL bereits angeschaut! Falls nicht, hier ist dein direkter Link: {vslUrl}
          
          üî• Exklusives Studenten-Angebot:
          Nur noch 24 Stunden: 50% Rabatt auf das Premium-Paket!
          Statt 197‚Ç¨ nur 97‚Ç¨ - inklusive 1:1 Coaching Session!
          
          Viele Studenten haben bereits mit dem Magic Tool System begonnen. Wirst du der n√§chste Erfolgsfall?
          
          Dein Magic Tool Team
        `,
        variables: ['firstName', 'vslUrl']
      },
      'student_followup_2': {
        subject: '‚ö° Letzte Chance: Studenten-Rabatt l√§uft ab!',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #dc2626;">‚ö° Letzte Chance: Studenten-Rabatt l√§uft ab!</h1>
            <p>Hallo {firstName},</p>
            <p>dein exklusiver Studenten-Rabatt l√§uft in wenigen Stunden ab!</p>
            
            <div style="background: #fee2e2; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #dc2626;">
              <h3 style="color: #dc2626;">‚è∞ Nur noch 6 Stunden:</h3>
              <p><strong>Magic Tool Premium f√ºr Studenten</strong></p>
              <p>Statt 197‚Ç¨ nur 97‚Ç¨</p>
              <p>‚úÖ 1:1 Coaching Session (30 Min)</p>
              <p>‚úÖ Exklusive Studenten-Strategien</p>
              <p>‚úÖ Community-Zugang</p>
              <p>‚úÖ Priorit√§ts-Support</p>
            </div>
            
            <p><a href="{vslUrl}" style="background: #dc2626; color: white; padding: 16px 32px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: bold; font-size: 18px;">üöÄ JETZT KAUFEN & SPAREN</a></p>
            
            <p>Nach Ablauf des Rabatts kostet das Premium-Paket wieder 197‚Ç¨.</p>
            <p>Dein Magic Tool Team</p>
          </div>
        `,
        text: `
          Letzte Chance: Studenten-Rabatt l√§uft ab!
          
          Hallo {firstName},
          
          dein exklusiver Studenten-Rabatt l√§uft in wenigen Stunden ab!
          
          ‚è∞ Nur noch 6 Stunden:
          Magic Tool Premium f√ºr Studenten
          Statt 197‚Ç¨ nur 97‚Ç¨
          ‚úÖ 1:1 Coaching Session (30 Min)
          ‚úÖ Exklusive Studenten-Strategien
          ‚úÖ Community-Zugang
          ‚úÖ Priorit√§ts-Support
          
          JETZT KAUFEN: {vslUrl}
          
          Nach Ablauf des Rabatts kostet das Premium-Paket wieder 197‚Ç¨.
          
          Dein Magic Tool Team
        `,
        variables: ['firstName', 'vslUrl']
      },
      'student_reminder': {
        subject: 'üéØ {firstName}, dein Magic Tool wartet auf dich!',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #059669;">üéØ Dein Magic Tool wartet auf dich!</h1>
            <p>Hallo {firstName},</p>
            <p>ich habe bemerkt, dass du noch nicht mit dem Magic Tool System gestartet bist. Vielleicht hast du Fragen oder brauchst mehr Informationen?</p>
            
            <div style="background: #ecfdf5; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h3 style="color: #059669;">üí° H√§ufige Fragen von Studenten:</h3>
              <p><strong>Q: Wie viel Zeit brauche ich t√§glich?</strong><br>
              A: Nur 30-60 Minuten am Tag reichen aus!</p>
              
              <p><strong>Q: Brauche ich Vorkenntnisse?</strong><br>
              A: Nein, alles wird Schritt f√ºr Schritt erkl√§rt!</p>
              
              <p><strong>Q: Wann sehe ich erste Ergebnisse?</strong><br>
              A: Viele Studenten sehen erste Erfolge in 2-4 Wochen!</p>
            </div>
            
            <p><a href="{vslUrl}" style="background: #059669; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">üéØ Jetzt mehr erfahren</a></p>
            
            <p>Falls du Fragen hast, antworte einfach auf diese E-Mail!</p>
            <p>Dein Magic Tool Team</p>
          </div>
        `,
        text: `
          Dein Magic Tool wartet auf dich!
          
          Hallo {firstName},
          
          ich habe bemerkt, dass du noch nicht mit dem Magic Tool System gestartet bist. Vielleicht hast du Fragen oder brauchst mehr Informationen?
          
          üí° H√§ufige Fragen von Studenten:
          Q: Wie viel Zeit brauche ich t√§glich?
          A: Nur 30-60 Minuten am Tag reichen aus!
          
          Q: Brauche ich Vorkenntnisse?
          A: Nein, alles wird Schritt f√ºr Schritt erkl√§rt!
          
          Q: Wann sehe ich erste Ergebnisse?
          A: Viele Studenten sehen erste Erfolge in 2-4 Wochen!
          
          Jetzt mehr erfahren: {vslUrl}
          
          Falls du Fragen hast, antworte einfach auf diese E-Mail!
          
          Dein Magic Tool Team
        `,
        variables: ['firstName', 'vslUrl']
      },

      // EMPLOYEE TEMPLATES
      'employee_welcome': {
        subject: 'üíº Willkommen im Business-Programm, {firstName}!',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #059669;">üíº Willkommen im Business-Programm!</h1>
            <p>Hallo {firstName},</p>
            <p>herzlich willkommen im Magic Tool System f√ºr Angestellte!</p>
            <p>Du bist jetzt Teil einer exklusiven Community von Vollzeit-Angestellten, die bereits 2.000‚Ç¨+ Zusatzeinkommen generieren.</p>
            
            <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h3 style="color: #166534;">Dein Skalierungsplan:</h3>
              <ol>
                <li>Schau dir die VSL an: <a href="{vslUrl}">Hier klicken</a></li>
                <li>Lade deine Business-Automatisierung herunter</li>
                <li>Trete der VIP-Community bei</li>
              </ol>
            </div>
            
            <p>Viel Erfolg auf deinem Weg zu 5.000‚Ç¨+ monatlich!</p>
            <p>Dein Magic Tool Team</p>
          </div>
        `,
        text: `
          Willkommen im Business-Programm!
          
          Hallo {firstName},
          
          herzlich willkommen im Magic Tool System f√ºr Angestellte!
          
          Dein Skalierungsplan:
          1. Schau dir die VSL an: {vslUrl}
          2. Lade deine Business-Automatisierung herunter
          3. Trete der VIP-Community bei
          
          Viel Erfolg!
          Dein Magic Tool Team
        `,
        variables: ['firstName', 'vslUrl']
      },
      'employee_followup_1': {
        subject: 'üöÄ Dein Business-Skalierungsplan wartet!',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #059669;">üöÄ Dein Business-Skalierungsplan</h1>
            <p>Hallo {firstName},</p>
            <p>als Vollzeit-Angestellter wei√üt du, wie wichtig ein stabiles Zusatzeinkommen ist. Das Magic Tool System ist speziell f√ºr Menschen wie dich entwickelt!</p>
            
            <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h3 style="color: #166534;">üíº Business-Vorteile:</h3>
              <ul>
                <li>Flexible Arbeitszeiten (nach der Arbeit)</li>
                <li>Skalierbares System</li>
                <li>Business-Automatisierung</li>
                <li>VIP-Community f√ºr Angestellte</li>
              </ul>
            </div>
            
            <p><a href="{vslUrl}" style="background: #059669; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">üíº Business-VSL ansehen</a></p>
            
            <p>Dein Magic Tool Team</p>
          </div>
        `,
        text: `
          Dein Business-Skalierungsplan
          
          Hallo {firstName},
          
          als Vollzeit-Angestellter wei√üt du, wie wichtig ein stabiles Zusatzeinkommen ist. Das Magic Tool System ist speziell f√ºr Menschen wie dich entwickelt!
          
          üíº Business-Vorteile:
          ‚Ä¢ Flexible Arbeitszeiten (nach der Arbeit)
          ‚Ä¢ Skalierbares System
          ‚Ä¢ Business-Automatisierung
          ‚Ä¢ VIP-Community f√ºr Angestellte
          
          Business-VSL ansehen: {vslUrl}
          
          Dein Magic Tool Team
        `,
        variables: ['firstName', 'vslUrl']
      },
      'employee_followup_2': {
        subject: 'üî• VIP-Business-Strategien - Nur f√ºr Angestellte!',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #dc2626;">üî• VIP-Business-Strategien</h1>
            <p>Hallo {firstName},</p>
            <p>als Angestellter hast du Zugang zu exklusiven Business-Strategien, die andere nicht kennen!</p>
            
            <div style="background: #fef2f2; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h3 style="color: #dc2626;">‚ö° Exklusive Business-Boni:</h3>
              <p><strong>Magic Tool Premium Business</strong></p>
              <p>‚úÖ 1:1 Business-Coaching (60 Min)</p>
              <p>‚úÖ Skalierungs-Strategien</p>
              <p>‚úÖ Exklusive Business-Tools</p>
              <p>‚úÖ VIP-Community</p>
              <p>‚úÖ Priorit√§ts-Support</p>
            </div>
            
            <p><a href="{vslUrl}" style="background: #dc2626; color: white; padding: 16px 32px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: bold; font-size: 18px;">üöÄ VIP-BUSINESS-PAKET</a></p>
            
            <p>Dein Magic Tool Team</p>
          </div>
        `,
        text: `
          VIP-Business-Strategien
          
          Hallo {firstName},
          
          als Angestellter hast du Zugang zu exklusiven Business-Strategien, die andere nicht kennen!
          
          ‚ö° Exklusive Business-Boni:
          Magic Tool Premium Business
          ‚úÖ 1:1 Business-Coaching (60 Min)
          ‚úÖ Skalierungs-Strategien
          ‚úÖ Exklusive Business-Tools
          ‚úÖ VIP-Community
          ‚úÖ Priorit√§ts-Support
          
          VIP-BUSINESS-PAKET: {vslUrl}
          
          Dein Magic Tool Team
        `,
        variables: ['firstName', 'vslUrl']
      },
      'employee_reminder': {
        subject: 'üíº {firstName}, dein Business wartet auf dich!',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #059669;">üíº Dein Business wartet auf dich!</h1>
            <p>Hallo {firstName},</p>
            <p>ich wei√ü, dass du als Angestellter wenig Zeit hast. Deshalb habe ich das Magic Tool System so entwickelt, dass es perfekt in deinen Alltag passt.</p>
            
            <div style="background: #ecfdf5; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h3 style="color: #059669;">‚è∞ Zeitmanagement f√ºr Angestellte:</h3>
              <p><strong>Nur 1-2 Stunden pro Woche</strong> reichen aus, um 2.000‚Ç¨+ Zusatzeinkommen aufzubauen!</p>
              <p>‚Ä¢ Nach der Arbeit oder am Wochenende</p>
              <p>‚Ä¢ Vollst√§ndig automatisiert</p>
              <p>‚Ä¢ Skalierbar nach deinen W√ºnschen</p>
            </div>
            
            <p><a href="{vslUrl}" style="background: #059669; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">üíº Business-Plan ansehen</a></p>
            
            <p>Dein Magic Tool Team</p>
          </div>
        `,
        text: `
          Dein Business wartet auf dich!
          
          Hallo {firstName},
          
          ich wei√ü, dass du als Angestellter wenig Zeit hast. Deshalb habe ich das Magic Tool System so entwickelt, dass es perfekt in deinen Alltag passt.
          
          ‚è∞ Zeitmanagement f√ºr Angestellte:
          Nur 1-2 Stunden pro Woche reichen aus, um 2.000‚Ç¨+ Zusatzeinkommen aufzubauen!
          ‚Ä¢ Nach der Arbeit oder am Wochenende
          ‚Ä¢ Vollst√§ndig automatisiert
          ‚Ä¢ Skalierbar nach deinen W√ºnschen
          
          Business-Plan ansehen: {vslUrl}
          
          Dein Magic Tool Team
        `,
        variables: ['firstName', 'vslUrl']
      },

      // PARENT TEMPLATES
      'parent_welcome': {
        subject: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Willkommen im Familien-Programm, {firstName}!',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #7c3aed;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Willkommen im Familien-Programm!</h1>
            <p>Hallo {firstName},</p>
            <p>herzlich willkommen im Magic Tool System f√ºr Eltern!</p>
            <p>Du bist jetzt Teil einer exklusiven Community von Eltern, die bereits 800-1.200‚Ç¨ flexibles Einkommen neben der Familie aufbauen.</p>
            
            <div style="background: #faf5ff; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h3 style="color: #5b21b6;">Dein Familien-Plan:</h3>
              <ol>
                <li>Schau dir die VSL an: <a href="{vslUrl}">Hier klicken</a></li>
                <li>Lade deine Familien-Strategien herunter</li>
                <li>Trete der Eltern-Community bei</li>
              </ol>
            </div>
            
            <p>Viel Erfolg auf deinem Weg zu flexiblem Familien-Einkommen!</p>
            <p>Dein Magic Tool Team</p>
          </div>
        `,
        text: `
          Willkommen im Familien-Programm!
          
          Hallo {firstName},
          
          herzlich willkommen im Magic Tool System f√ºr Eltern!
          
          Dein Familien-Plan:
          1. Schau dir die VSL an: {vslUrl}
          2. Lade deine Familien-Strategien herunter
          3. Trete der Eltern-Community bei
          
          Viel Erfolg!
          Dein Magic Tool Team
        `,
        variables: ['firstName', 'vslUrl']
      },
      'parent_followup_1': {
        subject: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Dein flexibles Familien-Einkommen wartet!',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #7c3aed;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Dein flexibles Familien-Einkommen</h1>
            <p>Hallo {firstName},</p>
            <p>als Elternteil wei√üt du, wie wichtig es ist, Zeit f√ºr die Familie zu haben und trotzdem ein gutes Einkommen zu generieren.</p>
            
            <div style="background: #faf5ff; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h3 style="color: #5b21b6;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familien-Vorteile:</h3>
              <ul>
                <li>Flexible Arbeitszeiten (wenn die Kinder schlafen)</li>
                <li>Work-Life-Balance</li>
                <li>Familien-freundliche Strategien</li>
                <li>Eltern-Community</li>
              </ul>
            </div>
            
            <p><a href="{vslUrl}" style="background: #7c3aed; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familien-VSL ansehen</a></p>
            
            <p>Dein Magic Tool Team</p>
          </div>
        `,
        text: `
          Dein flexibles Familien-Einkommen
          
          Hallo {firstName},
          
          als Elternteil wei√üt du, wie wichtig es ist, Zeit f√ºr die Familie zu haben und trotzdem ein gutes Einkommen zu generieren.
          
          üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familien-Vorteile:
          ‚Ä¢ Flexible Arbeitszeiten (wenn die Kinder schlafen)
          ‚Ä¢ Work-Life-Balance
          ‚Ä¢ Familien-freundliche Strategien
          ‚Ä¢ Eltern-Community
          
          Familien-VSL ansehen: {vslUrl}
          
          Dein Magic Tool Team
        `,
        variables: ['firstName', 'vslUrl']
      },
      'parent_followup_2': {
        subject: 'üéÅ Familien-freundliche Strategien - Exklusiv f√ºr Eltern!',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #dc2626;">üéÅ Familien-freundliche Strategien</h1>
            <p>Hallo {firstName},</p>
            <p>als Elternteil hast du Zugang zu speziellen Strategien, die perfekt in deinen Familienalltag passen!</p>
            
            <div style="background: #fef2f2; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h3 style="color: #dc2626;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Exklusive Familien-Boni:</h3>
              <p><strong>Magic Tool Premium Familien</strong></p>
              <p>‚úÖ 1:1 Familien-Coaching (45 Min)</p>
              <p>‚úÖ Exklusive Familien-Tools</p>
              <p>‚úÖ Work-Life-Balance Guide</p>
              <p>‚úÖ Eltern-Community</p>
              <p>‚úÖ Flexible Arbeitszeiten</p>
            </div>
            
            <p><a href="{vslUrl}" style="background: #dc2626; color: white; padding: 16px 32px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: bold; font-size: 18px;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ FAMILIEN-PREMIUM</a></p>
            
            <p>Dein Magic Tool Team</p>
          </div>
        `,
        text: `
          Familien-freundliche Strategien
          
          Hallo {firstName},
          
          als Elternteil hast du Zugang zu speziellen Strategien, die perfekt in deinen Familienalltag passen!
          
          üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Exklusive Familien-Boni:
          Magic Tool Premium Familien
          ‚úÖ 1:1 Familien-Coaching (45 Min)
          ‚úÖ Exklusive Familien-Tools
          ‚úÖ Work-Life-Balance Guide
          ‚úÖ Eltern-Community
          ‚úÖ Flexible Arbeitszeiten
          
          FAMILIEN-PREMIUM: {vslUrl}
          
          Dein Magic Tool Team
        `,
        variables: ['firstName', 'vslUrl']
      },
      'parent_reminder': {
        subject: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ {firstName}, deine Familie wartet auf mehr Zeit!',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #7c3aed;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Deine Familie wartet auf mehr Zeit!</h1>
            <p>Hallo {firstName},</p>
            <p>ich verstehe, dass du als Elternteil wenig Zeit hast. Das Magic Tool System ist speziell f√ºr Eltern entwickelt, die mehr Zeit mit der Familie verbringen m√∂chten.</p>
            
            <div style="background: #faf5ff; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h3 style="color: #5b21b6;">‚è∞ Familien-Zeitmanagement:</h3>
              <p><strong>Nur 30-60 Minuten pro Tag</strong> reichen aus, um 800-1.200‚Ç¨ flexibles Einkommen aufzubauen!</p>
              <p>‚Ä¢ Wenn die Kinder schlafen</p>
              <p>‚Ä¢ Am Wochenende</p>
              <p>‚Ä¢ Vollst√§ndig flexibel</p>
            </div>
            
            <p><a href="{vslUrl}" style="background: #7c3aed; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familien-Plan ansehen</a></p>
            
            <p>Dein Magic Tool Team</p>
          </div>
        `,
        text: `
          Deine Familie wartet auf mehr Zeit!
          
          Hallo {firstName},
          
          ich verstehe, dass du als Elternteil wenig Zeit hast. Das Magic Tool System ist speziell f√ºr Eltern entwickelt, die mehr Zeit mit der Familie verbringen m√∂chten.
          
          ‚è∞ Familien-Zeitmanagement:
          Nur 30-60 Minuten pro Tag reichen aus, um 800-1.200‚Ç¨ flexibles Einkommen aufzubauen!
          ‚Ä¢ Wenn die Kinder schlafen
          ‚Ä¢ Am Wochenende
          ‚Ä¢ Vollst√§ndig flexibel
          
          Familien-Plan ansehen: {vslUrl}
          
          Dein Magic Tool Team
        `,
        variables: ['firstName', 'vslUrl']
      }
    };

    return templates[`${personaType}_${templateId}`] || null;
  }

  private personalizeTemplate(template: string, leadData: any, personaType: string): string {
    return template
      .replace(/{firstName}/g, leadData?.firstName || 'Lieber Interessent')
      .replace(/{email}/g, leadData?.email || '')
      .replace(/{personaType}/g, personaType)
      .replace(/{vslUrl}/g, `http://localhost:3000/vsl?persona=${personaType}&leadId=${leadData?.id || ''}`)
      .replace(/{quizAnswers}/g, JSON.stringify(leadData?.quizAnswers || {}));
  }

  private async trackEmailSent(emailData: EmailData, messageId: string): Promise<void> {
    await storage.createAnalyticsEvent({
      event: 'email_sent',
      page: '/email',
      userId: emailData.leadId?.toString(),
      data: JSON.stringify({
        to: emailData.to,
        subject: emailData.subject,
        personaType: emailData.personaType,
        templateId: emailData.templateId,
        messageId,
        timestamp: new Date().toISOString()
      })
    });
  }

  private async trackEmailError(emailData: EmailData, error: any): Promise<void> {
    await storage.createAnalyticsEvent({
      event: 'email_error',
      page: '/email',
      userId: emailData.leadId?.toString(),
      data: JSON.stringify({
        to: emailData.to,
        subject: emailData.subject,
        personaType: emailData.personaType,
        templateId: emailData.templateId,
        error: error.message,
        timestamp: new Date().toISOString()
      })
    });
  }

  async getEmailStats(personaType?: string): Promise<any> {
    // Hier w√ºrden normalerweise E-Mail-Statistiken aus der Datenbank geladen
    const baseStats = {
      sent: 0,
      delivered: 0,
      opened: 0,
      clicked: 0,
      bounced: 0,
      unsubscribed: 0
    };

    // Simuliere Persona-spezifische Statistiken
    if (personaType) {
      switch (personaType) {
        case 'student':
          return {
            ...baseStats,
            sent: 1250,
            delivered: 1187,
            opened: 892,
            clicked: 445,
            bounced: 63,
            unsubscribed: 12,
            openRate: 75.1,
            clickRate: 37.5
          };
        case 'employee':
          return {
            ...baseStats,
            sent: 890,
            delivered: 845,
            opened: 676,
            clicked: 338,
            bounced: 45,
            unsubscribed: 8,
            openRate: 80.0,
            clickRate: 40.0
          };
        case 'parent':
          return {
            ...baseStats,
            sent: 1100,
            delivered: 1045,
            opened: 836,
            clicked: 418,
            bounced: 55,
            unsubscribed: 10,
            openRate: 80.0,
            clickRate: 40.0
          };
      }
    }

    return baseStats;
  }
}

export const smtpService = new SMTPService(); 